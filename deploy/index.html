<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Our PSLE Adventure</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://firestore.googleapis.com">

    <!-- Firebase SDK (Compat Version for single-file HTML) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
</head>

<body>

    <!-- Login Gateway Overlay -->
    <div id="login-overlay">
        <div class="entry-card">
            <h1 class="entry-title">PSLE Prep</h1>
            <p class="entry-subtitle">Master your exams with localized practice papers and smart tracking.</p>
            <button onclick="loginGoogle()"
                style="width:100%; padding:15px; background:white; color:#1e1b4b; border:none; border-radius:12px; font-weight:700; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:12px; font-size:1.1rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3);">
                <svg width="24" height="24" viewBox="0 0 18 18">
                    <path
                        d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z"
                        fill="#4285f4" />
                    <path
                        d="M9 18c2.43 0 4.467-.806 5.956-2.184L12.048 13.56c-.813.545-1.854.867-3.048.867-2.344 0-4.328-1.584-5.036-3.711H.957v2.332A8.997 8.997 0 009 18z"
                        fill="#34a853" />
                    <path
                        d="M3.964 10.716a5.41 5.41 0 01-.282-1.716c0-.6.101-1.185.282-1.716V4.952H.957A8.996 8.996 0 000 9c0 1.452.348 2.827.957 4.048l3.007-2.332z"
                        fill="#fbbc05" />
                    <path
                        d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0 5.46 0 2.403 2.015.957 4.952l3.007 2.332c.708-2.127 2.692-3.711 5.036-3.711z"
                        fill="#ea4335" />
                </svg>
                Sign in with Google
            </button>
            <p style="margin-top:20px; font-size:0.8rem; opacity:0.6;">Your progress is synced automatically to the
                cloud.</p>
        </div>
    </div>

    <div id="sidebar" style="display:none;">
        <div id="header">
            <!-- Auth Section -->
            <!-- Auth Section - Removed Login with Google from here -->
            <div id="auth-section" style="display:none;"></div>

            <div id="profile-container" style="display:none; margin-bottom: 20px;">
                <div class="profile-left">
                    <div id="user-photo" onclick="openAvatarModal()"
                        style="width:48px; height:48px; border-radius:50%; border:2px solid #fbbf24; cursor:pointer; background-image:url('avatars.png'); background-size:800% 800%; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.2);"
                        title="Change Avatar"></div>
                </div>
                <div class="profile-right" onclick="showXPView()" style="cursor:pointer;" title="View XP Details">
                    <div class="profile-header-row">
                        <span id="user-name" onclick="event.stopPropagation(); updateUserName()"
                            title="Click to change name" class="profile-name-text">Guest</span>
                        <span id="profile-level-badge" class="profile-lvl-badge">Lvl 1</span>
                    </div>

                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 4px;">
                        <span class="profile-rank-text">Master Aspirant</span>
                        <div id="sync-status" class="sync-status-indicator"></div>
                    </div>

                    <!-- XP Bar -->
                    <div class="xp-bar-container">
                        <div id="profile-xp-fill" class="xp-bar-fill" style="width: 0%;"></div>
                    </div>
                    <div class="profile-xp-row">
                        <span id="profile-xp-text">0 / 500 XP</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Guest Profile Removed (Auth is Mandatory) -->
        <div id="guest-profile" style="display:none;"></div>

        <!-- Stats Grid -->
        <div id="stats-grid">
            <div class="stat-card-mini" onclick="openAnalytics()" title="Click for details">
                <span class="stat-val-big" id="completed-stat">0</span>
                <span class="stat-label-mini">Done</span>
            </div>
            <div class="stat-card-mini" onclick="openAnalytics()" title="Click for details">
                <span class="stat-val-big" id="percent-stat">0%</span>
                <span class="stat-label-mini">Complete</span>
            </div>
            <div class="stat-card-mini yellow-card" onclick="showExamPlanView()" title="View Exam Plan">
                <span class="stat-val-big" id="exam-prep-stat">0%</span>
                <span class="stat-label-mini">Exam Prep</span>
            </div>
        </div>

        <!-- Filters (Moved inside sidebar) -->
        <div id="filters">
            <div class="span-1" id="filter-level"></div>
            <div class="span-1" id="filter-term"></div>
            <div class="span-1" id="filter-year"></div>
            <div class="span-1" id="filter-subject"></div>
            <div class="span-1" id="filter-status"></div>
            <div class="span-1" id="filter-notes"></div>
            <div class="span-3" id="filter-school"></div>
        </div>

        <!-- Contribution Graph (Moved below filters) -->
        <div style="margin-top: 30px;">
            <div id="sidebar-contrib"></div>
        </div>

        <!-- Semver Display -->
        <div
            style="margin-top: auto; padding: 20px; font-size: 0.75rem; color: #94a3b8; opacity: 0.6; text-align: center;">
            <<<<<<< HEAD Version 1.3.4=======Version 1.3.5>>>>>>> 08dd1c4 (Feat: Add Sync Animation & Fix Deployment
                Workflow (v1.3.5))
        </div>

    </div>


    <!-- Paper List Moved to Main View -->


    <div id="main-view">

        <!-- View 1: Results -->
        <div id="results-view" class="view-pane">
            <div id="filter-stats-display"
                style="padding: 10px 0; margin: 0 auto; max-width: 900px; font-size: 1.1rem; font-weight: 600; color: #fbbf24; opacity: 0.9; text-align: left;">
                Found 0 papers</div>
            <div id="paper-list">
                <!-- Cards go here -->
            </div>
        </div>

        <!-- View 2: PDF Viewer -->
        <div id="pdf-view" class="view-pane" style="display:none; background-color: var(--bg-dark);">
            <div id="top-toolbar">
                <div style="display:flex; align-items:center; gap:10px;">
                    <button class="btn-action" style="background:#334155; color:white; padding:8px 12px;"
                        onclick="switchView('results')">‚óÄ Back</button>
                    <div id="paper-info">
                        <h2 id="current-title">Paper Title</h2>
                        <p id="current-details">Details</p>
                    </div>
                </div>
                <div>
                    <button id="mark-btn" class="btn-action btn-mark" onclick="handleMainMark()">‚≠ê Mark
                        Complete</button>
                    <a id="open-btn" href="#" target="_blank" class="btn-action btn-open">Open PDF ‚Üó</a>
                </div>
            </div>

            <iframe id="pdf-viewer"></iframe>

            <div id="notes-pane">
                <div id="notes-header" onclick="toggleNotes()">
                    <span id="notes-header-label">üìù Field Notes</span>
                    <span class="toggle-icon">‚ñº</span>
                </div>
                <textarea id="notes-input"
                    placeholder="// Write your observations here... (e.g. 'Tricky ratio question in Q5')"
                    oninput="saveNotes()"></textarea>
            </div>
        </div>

        <!-- View 3: Analytics -->
        <div id="analytics-view" class="view-pane" style="display:none;">
            <div class="analytics-container">
                <div class="analytics-header">
                    <h2>üìä Analytics Dashboard</h2>
                    <button class="analytics-close" onclick="switchView('results')">‚úï</button>
                </div>
                <div class="analytics-controls">
                    <div class="toggle-group" id="subject-toggle"></div>
                    <div class="toggle-group" id="level-toggle"></div>
                    <div class="toggle-group">
                        <button class="toggle-btn active" onclick="setDisplayMode('percent')">%</button>
                        <button class="toggle-btn" onclick="setDisplayMode('count')">Count</button>
                    </div>
                </div>

                <div style="margin-bottom: 25px;">
                    <div id="analytics-contrib"></div>
                </div>

                <div class="summary-stats" id="summary-stats"></div>
                <div class="analytics-grid" id="analytics-grid"></div>
            </div>
        </div>

        <!-- View 4: Exam Plan -->
        <div id="exam-view" class="view-pane" style="display:none;">
            <div id="exam-view-container" style="padding: 20px; color: white;">
                <!-- Exam Content Here -->
            </div>
        </div>

        <!-- View 5: XP System -->
        <div id="xp-view" class="view-pane" style="display:none;">
            <div id="xp-view-container" style="padding: 40px; color: white; max-width: 1000px; margin: 0 auto;">
                <!-- XP Content Here -->
            </div>
        </div>

    </div>

    <!-- Modal -->
    <div id="modal" class="modal-overlay">
        <div class="modal-card">
            <h2 id="modal-congrats">üéâ Great Job!</h2>
            <p id="modal-subtext">You smashed it! When did you finish this?</p>
            <input type="date" id="completion-date" class="date-input">
            <button class="btn-save" onclick="saveCompletion()">Save Progress</button>
            <button class="btn-cancel" onclick="closeModal()">Cancel</button>
        </div>
    </div>

    <!-- Avatar Modal -->
    <div id="avatar-modal" class="modal-overlay" onclick="closeAvatarModal(event)">
        <div class="modal-card">
            <h2 style="margin-top:0; color:#fbbf24;">Choose Avatar</h2>
            <div id="avatar-grid"></div>
            <button class="btn-cancel" onclick="document.getElementById('avatar-modal').classList.remove('show')"
                style="margin-top:20px;color:white;">Close</button>
        </div>
    </div>

    <!-- Exam Dates Modal -->
    <div id="exam-dates-modal" class="modal-overlay">
        <div class="modal-card" style="max-width:500px;">
            <h2 style="margin-top:0; color:#fbbf24;">‚öôÔ∏è Update Exam Dates</h2>
            <p style="opacity:0.8; margin-bottom:20px;">Configure milestone dates for your level.</p>

            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; font-weight:600;">Select Level:</label>
                <div class="toggle-group" id="exam-level-toggle">
                    <button class="toggle-btn active" onclick="switchExamModalLevel('P4')">P4</button>
                    <button class="toggle-btn" onclick="switchExamModalLevel('P5')">P5</button>
                    <button class="toggle-btn" onclick="switchExamModalLevel('P6')">P6</button>
                </div>
            </div>

            <div
                style="display:grid; gap:15px; margin-bottom:25px; background:rgba(255,255,255,0.05); padding:20px; border-radius:12px; border:1px solid rgba(255,255,255,0.1);">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <label>WA1 Date:</label>
                    <input type="date" id="modal-date-wa1" class="date-input" style="width:180px;">
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <label>WA2 Date:</label>
                    <input type="date" id="modal-date-wa2" class="date-input" style="width:180px;">
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <label>EYE Date:</label>
                    <input type="date" id="modal-date-eye" class="date-input" style="width:180px;">
                </div>
            </div>

            <div style="margin-bottom:20px;">
                <label
                    style="display:block; margin-bottom:8px; font-weight:600; font-size: 0.85rem; color: #94a3b8; text-transform: uppercase;">Tracking
                    Goal:</label>
                <div class="toggle-group" id="modal-goal-toggle" style="height:48px; border-radius:12px;">
                    <button class="toggle-btn" onclick="setExamGoal(null)">Auto</button>
                    <button class="toggle-btn" onclick="setExamGoal('WA1')">WA1</button>
                    <button class="toggle-btn" onclick="setExamGoal('WA2')">WA2</button>
                    <button class="toggle-btn" onclick="setExamGoal('EYE')">EYE</button>
                </div>
            </div>

            <div style="display:flex; gap:10px;">
                <button class="btn-save" onclick="saveExamDates()" style="flex:1;">Save Settings</button>
                <button class="btn-cancel" onclick="closeExamDatesModal()" style="flex:1;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Welcome Summary Modal -->
    <div id="welcome-modal" class="modal-overlay">
        <div class="modal-card">
            <h2 id="welcome-title">Welcome back! üëã</h2>
            <p id="welcome-subtext" style="font-size:1.1rem; opacity:0.9; margin-bottom:25px; color:#fbbf24;">Here's
                what you've been up to:</p>

            <div class="summary-box">
                <div class="summary-item">
                    <span class="summary-label">Papers Today:</span>
                    <span class="summary-value" id="welcome-today-count">0</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">This Week:</span>
                    <span class="summary-value" id="welcome-week-count">0</span>
                </div>
            </div>

            <div class="milestone-alert" id="welcome-milestone-box">
                <div style="font-size:2rem;">üìÖ</div>
                <div>
                    <div style="font-weight:700; color:#fbbf24;" id="welcome-milestone-label">Upcoming: P4 WA1</div>
                    <div style="font-size:0.9rem; opacity:0.8;" id="welcome-milestone-days">49 days to go!</div>
                </div>
            </div>

            <button class="btn-save" onclick="closeWelcomeModal()" style="padding:15px; font-size:1.1rem;">Let's Get
                Started!</button>
        </div>
    </div>

    <!-- Analytics Modal -->
    <!-- Analytics Modal REMOVED (Moved to Main View) -->
    <!-- Script with cache-busting -->
    <script type="module" src="js/app.js"></script>
</body>

</html>